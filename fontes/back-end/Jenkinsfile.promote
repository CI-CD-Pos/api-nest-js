pipeline {
  agent any

  parameters {
    string(
      name: 'TAG',
      defaultValue: '',
      description: 'Tag de vers√£o sem√¢ntica (ex.: v1.0.10)'
    )
    choice(
      name: 'ENVIRONMENT',
      choices: ['DEV', 'STG', 'PROD'],
      description: 'Ambiente de destino para promo√ß√£o'
    )
  }

  environment {
    IMAGE = "api-nest-ci"
  }

  stages {

   
    stage('Validate Params') {
      steps {
        echo '=== 1/4 VALIDATE PARAMS ==='
        script {
          if (!params.TAG?.trim()) {
            error "‚ùå Par√¢metro TAG √© obrigat√≥rio. Informe uma vers√£o (ex.: v1.0.10)"
          }
          echo "üìã TAG: ${params.TAG}"
          echo "üìã ENVIRONMENT: ${params.ENVIRONMENT}"
          echo "üìã Imagem origem: ${IMAGE}:${params.TAG}"
          echo "üìã Imagem destino: ${IMAGE}:${params.ENVIRONMENT.toLowerCase()}-${params.TAG}"
        }
      }
    }

    stage('Validate Source Image') {
      steps {
        echo '=== 2/4 VALIDATE SOURCE IMAGE ==='
        script {
          def srcImage = "${IMAGE}:${params.TAG}"
          def exists = sh(script: "docker image inspect ${srcImage} > /dev/null 2>&1", returnStatus: true)
          if (exists != 0) {
            error "‚ùå Imagem ${srcImage} n√£o encontrada! Execute o Pipeline CI primeiro para gerar esta vers√£o."
          }
          echo "‚úÖ Imagem ${srcImage} encontrada"
        }
      }
    }
    stage('Validate Chain') {
      steps {
        echo '=== 3/4 VALIDATE CHAIN ==='
        script {
          def tag = params.TAG
          def env = params.ENVIRONMENT

          if (env == 'STG') {
           
            def devImage = "${IMAGE}:dev-${tag}"
            def exists = sh(script: "docker image inspect ${devImage} > /dev/null 2>&1", returnStatus: true)
            if (exists != 0) {
              error "‚ùå Cadeia quebrada! Para promover para STG, a tag DEV deve existir.\n" +
                    "   Imagem esperada: ${devImage}\n" +
                    "   Execute primeiro: TAG=${tag}, ENVIRONMENT=DEV"
            }
            echo "‚úÖ Cadeia v√°lida: ${devImage} existe ‚Üí pode promover para STG"
          }

          if (env == 'PROD') {
         
            def stgImage = "${IMAGE}:stg-${tag}"
            def exists = sh(script: "docker image inspect ${stgImage} > /dev/null 2>&1", returnStatus: true)
            if (exists != 0) {
              error "‚ùå Cadeia quebrada! Para promover para PROD, a tag STG deve existir.\n" +
                    "   Imagem esperada: ${stgImage}\n" +
                    "   Execute primeiro: TAG=${tag}, ENVIRONMENT=STG"
            }
            echo "‚úÖ Cadeia v√°lida: ${stgImage} existe ‚Üí pode promover para PROD"
          }

          if (env == 'DEV') {
            echo "‚úÖ DEV √© o primeiro n√≠vel ‚Äî sem depend√™ncia de cadeia"
          }
        }
      }
    }

  
    stage('Promote') {
      steps {
        echo '=== 4/4 PROMOTE ==='
        script {
          def tag = params.TAG
          def env = params.ENVIRONMENT.toLowerCase()
          def srcImage = "${IMAGE}:${tag}"
          def destImage = "${IMAGE}:${env}-${tag}"

          sh "docker tag ${srcImage} ${destImage}"

          echo "============================================"
          echo "‚úÖ PROMO√á√ÉO CONCLU√çDA COM SUCESSO!"
          echo "============================================"
          echo "   Origem:  ${srcImage}"
          echo "   Destino: ${destImage}"
          echo "   Ambiente: ${params.ENVIRONMENT}"
          echo "============================================"
          echo ""
          echo "üì¶ Para fazer deploy manual, execute:"
          echo "   TAG=${env}-${tag} docker compose -f deploy/compose.yaml up -d"
          echo "============================================"

          sh "docker images ${IMAGE} --format 'table {{.Repository}}\\t{{.Tag}}\\t{{.CreatedAt}}'"
        }
      }
    }
  }

  post {
    always {
      echo '=== PIPELINE DE PROMO√á√ÉO FINALIZADO ==='
    }
    success {
      echo "‚úÖ Tag ${params.ENVIRONMENT.toLowerCase()}-${params.TAG} criada com sucesso!"
    }
    failure {
      echo '‚ùå Pipeline de promo√ß√£o FALHOU ‚Äî verifique os logs acima.'
    }
  }
}
